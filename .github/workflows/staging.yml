name: ðŸš€ Staging Deployment Pipeline - AWS Ready

on:
  push:
    branches: [staging]
  pull_request:
    branches: [staging]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'
  AWS_REGION: ap-southeast-1
  ECR_REPOSITORY: dromic-staging
  ECS_SERVICE: dromic-staging-service
  ECS_CLUSTER: dromic-staging
  CONTAINER_NAME: dromic-app
  
jobs:
  # ============================================================================
  # ðŸ” Code Quality & Security Checks
  # ============================================================================
  code-quality:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          
      - name: ðŸ”Ž Run ESLint
        run: npm run lint
        
      - name: ðŸ”§ TypeScript Type Check
        run: npm run type-check
        
      - name: ðŸ“Š Format Check
        run: npm run format:check
        continue-on-error: true

  # ============================================================================
  # ðŸ§ª Testing Suite
  # ============================================================================
  test:
    name: ðŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        test-type: [unit, integration]
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ðŸ§ª Run Tests
        run: npm run test:coverage
        env:
          NODE_ENV: test
          
      - name: ðŸ“Š Upload Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: ${{ matrix.test-type }}
          name: coverage-${{ matrix.test-type }}

  # ============================================================================
  # ðŸ—ï¸ Build Application
  # ============================================================================
  build:
    name: ðŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ðŸ—ï¸ Build for Staging
        run: npm run build:staging
        env:
          NODE_ENV: staging
          NEXT_PUBLIC_ENV: staging
          
      - name: ðŸ“ Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: staging-build
          path: |
            .next/
            public/
            package.json
          retention-days: 7

  # ============================================================================
  # ðŸš€ Deploy to Staging
  # ============================================================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    environment: staging
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ“ Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: staging-build
          
      - name: ðŸš€ Deploy to Staging Server
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          echo "ðŸ“Š Build completed successfully"
          echo "ðŸ”— Staging URL: https://staging.dromic-is.dswd.gov.ph"
          # TODO: Add actual deployment commands here
          # Example deployment commands:
          # rsync -avz --delete ./ staging-server:/var/www/dromic-is/
          # ssh staging-server 'cd /var/www/dromic-is && pm2 restart dromic-is-staging'
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_KEY: ${{ secrets.STAGING_SSH_KEY }}
          
      - name: ðŸ” Health Check
        run: |
          echo "ðŸ” Running post-deployment health checks..."
          # TODO: Add health check commands
          # curl -f https://staging.dromic-is.dswd.gov.ph/api/health
          
      - name: ðŸ“§ Notify Deployment
        run: |
          echo "ðŸ“§ Deployment notification sent"
          echo "âœ… Staging deployment completed successfully"

  # ============================================================================
  # ðŸ”’ Security Scan
  # ============================================================================
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ”’ Run Security Audit
        run: npm audit --audit-level moderate
        continue-on-error: true
        
      - name: ðŸ›¡ï¸ Check Dependencies
        run: |
          npx audit-ci --moderate
        continue-on-error: true

  # ============================================================================
  # ðŸ“Š Performance Monitoring
  # ============================================================================
  performance:
    name: ðŸ“Š Performance Check
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ“Š Bundle Size Analysis
        run: |
          echo "ðŸ“Š Analyzing bundle size..."
          # TODO: Add bundle size analysis
          # npm run analyze

  # ============================================================================
  # ðŸ“‹ Summary Report
  # ============================================================================  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [code-quality, test, build, security, deploy-aws]
    if: always()
    
    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "## ðŸš€ DROMIC-IS Staging Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âš ï¸ Warning' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AWS Deployment | ${{ needs.deploy-aws.result == 'success' && 'âœ… Deployed' || needs.deploy-aws.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Review any failed checks above" >> $GITHUB_STEP_SUMMARY
          echo "- Test the staging environment thoroughly" >> $GITHUB_STEP_SUMMARY
          echo "- Prepare for production deployment when ready" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.deploy-aws.result }}" == "success" ]]; then
            echo "- ðŸŒ **Staging URL:** https://staging.dromic-is.dswd.gov.ph" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # ðŸš€ AWS Deployment (Conditional)
  # ============================================================================
  deploy-aws:
    name: ðŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    needs: [code-quality, test, build, security]
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    
    environment:
      name: staging
      url: https://staging.dromic-is.dswd.gov.ph
      
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: ðŸ” Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        
      - name: ðŸ—ï¸ Build Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building Docker image for AWS deployment..."
          docker build \
            --file Dockerfile.staging \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            --build-arg BUILD_ENV=staging \
            .
            
      - name: ðŸš€ Push Image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Pushing image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
      - name: ðŸ“‹ Update ECS Task Definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: .aws/task-definition-staging.json
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          
      - name: ðŸš€ Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
          
      - name: ðŸ¥ Health Check
        run: |
          echo "Waiting for deployment to be healthy..."
          sleep 60
          
          # Health check with retry
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Health check attempt $attempt/$max_attempts"
            
            if curl -f -s https://staging.dromic-is.dswd.gov.ph/api/health > /dev/null; then
              echo "âœ… Health check passed!"
              curl -s https://staging.dromic-is.dswd.gov.ph/api/health | jq '.'
              break
            else
              echo "âŒ Health check failed, retrying in 30 seconds..."
              sleep 30
              attempt=$((attempt + 1))
            fi
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "ðŸš¨ Health check failed after $max_attempts attempts"
            exit 1
          fi
          
      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ AWS Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ECS Service:** ${{ env.ECS_SERVICE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ECS Cluster:** ${{ env.ECS_CLUSTER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Staging URL:** https://staging.dromic-is.dswd.gov.ph" >> $GITHUB_STEP_SUMMARY
